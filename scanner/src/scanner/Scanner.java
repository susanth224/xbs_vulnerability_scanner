
package scanner;

import java.io.IOException;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Attribute;
import org.jsoup.nodes.Attributes;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

public class Scanner {
    public static DB db = new DB();
    public static void main(String[] args) throws SQLException, IOException {
        db.runSql2("TRUNCATE Record;");
        String url = "http://10.1.11.111/onb";
        print("Fetching %s...", url);
        
        Document doc = Jsoup.connect(url).get();
        Elements links = doc.select("a[href]");
        //Elements media = doc.select("[src]");
        //Elements imports = doc.select("link[href]");
        processPage(url,doc);
        /*for (Element src : media) {
            if (src.tagName().equals("img")) {
                processPage(src.attr("abs:src"),doc);
            }
            else {
                processPage(src.attr("abs:src"),doc);
            }
        }
        
        for (Element link : imports) {
            processPage(link.attr("abs:href"),doc);
        }*/
        
        for (Element link : links) {
            processPage(link.attr("abs:href"),doc);
        }
        attacker();
    }
    public static void attacker()throws SQLException, IOException{
        String sql="select URL from Record";
        ResultSet rs= db.runSql(sql);
        String url=null;
        String z = null;
        String y = null;
        String temp=null;
        String temp2=null;
        while(rs.next())
        {
            url=rs.getString("URL");
            Document doc = Jsoup.connect(url).get();
            print("Finding forms of:- %s",url);
            Elements forms = doc.getElementsByTag("form");
            for(Element form : forms)
            {
                System.out.println(form.id());
                //System.out.println(form.tag());
                Attributes attributes = form.attributes();
                for(Attribute attribute : attributes)
                {
                    System.out.println(attribute.toString());
                    String x=attribute.toString();
                    if(x.startsWith("action") || x.startsWith("ACTION"))
                    {
                        y= x.substring(8,x.length()-1);
                        System.out.println(y);
                    }
                    if(x.startsWith("method") || x.startsWith("METHOD"))
                    {
                        z= x.substring(8,x.length()-1);
                        System.out.println(z);
                    }
                }
                Elements inputElements = form.getElementsByTag("input"); 
                for (Element inputElement : inputElements) { 
                String key = inputElement.attr("name");
                //String value = inputElement.attr("value");
                if("GET".equals(z) || "get".equals(z))
                {
                 temp=url+"/"+y+"?"+key+"=CHECKME";
                 temp2=url+"/"+y+"?"+key+"=";
                 //link li = new link(temp);
                 sqllink sl =new sqllink(temp2);
                }
                else if("POST".equals(z) || "POST".equals(z))
                {
                 temp=url+"/"+y+"?"+key+"=CHECKME";
                 link2 li2 = new link2(temp);
                 sqllink2 sl2 = new sqllink2(temp2);
                }
                }
            }
        }
    }

    private static void print(String msg, Object... args) {
        System.out.println(String.format(msg, args));
    }

    public static void processPage(String url,Document doc) throws SQLException, IOException{
        String sql = "select * from Record where URL = '"+url+"'";
        ResultSet rs = db.runSql(sql);
        if(rs.next()){
        }else{
            sql = "INSERT INTO `Crawler`.`Record` " + "(`URL`) VALUES " + "(?);";
            PreparedStatement stmt = db.conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS);
            stmt.setString(1, url);
            stmt.execute();
            System.out.println(url);
        }
        }
}